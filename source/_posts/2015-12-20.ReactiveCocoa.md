title: iOSå¼€å‘-ReactiveCocoa(RAC)æ¡†æ¶
date: 2015-12-20
categories:
- iOSå¼€å‘
tags:
- ReactiveCocoa
- æ¨¡å¼æ¡†æ¶
permalink: ios-ReactiveCocoa
---
## å‰è¨€
  æœ¬æ–‡æ˜¯æ ¹æ®[DeveloperLx](http://www.weibo.com/DeveloperLx?is_all=1#1450678339204)åœ¨æ–—é±¼ç›´æ’­`ReactiveCocoa`æ—¶æ•´ç†çš„æ–‡ç« ï¼ŒåŒæ—¶åŠ ä¸Šæœ¬äººçš„è§è§£ï¼Œè‹¥æœ‰é”™è¯¯å¸Œæœ›æŒ‡å‡ºã€‚
  æ„Ÿè°¢ DeveloperLx ä¸ºå¤§å®¶åšå‡ºçš„è´¡çŒ®ï¼Œè™½ç„¶ç›´æ’­å£°éŸ³å°äº†ç‚¹ï¼Œä½†æ»¡æ»¡çš„éƒ½æ˜¯å¹²è´§ ^v^
<!--more-->

## ç®€ä»‹

  ç¥é©¬æ˜¯RACï¼ŸReactiveCocoaï¼ˆç®€ç§°ä¸ºRACï¼‰,æ˜¯ç”±Githubå¼€æºçš„ä¸€ä¸ªåº”ç”¨äºiOSå’ŒOSå¼€å‘çš„æ–°æ¡†æ¶,Cocoaæ˜¯è‹¹æœæ•´å¥—æ¡†æ¶çš„ç®€ç§°ï¼Œå› æ­¤å¾ˆå¤šè‹¹æœæ¡†æ¶å–œæ¬¢ä»¥Cocoaç»“å°¾ã€‚å€Ÿç”¨**RayWenderlich**ä¸Šé¢çš„è¯ï¼š
  
>As an iOS developer, nearly every line of code you write is in reaction to some event; a button tap, a received network message, a property change (via Key Value Observing) or a change in userâ€™s location via CoreLocation are all good examples. However, these events are all encoded in different ways; as actions, delegates, KVO, callbacks and others. ReactiveCocoa defines a standard interface for events, so they can be more easily chained, filtered and composed using a basic set of tools.

ç¿»è¯‘è¿‡æ¥å°±æ˜¯ï¼š
>ä½œä¸ºä¸€ä¸ªiOSå¼€å‘è€…ï¼Œä½ å†™çš„æ¯ä¸€è¡Œä»£ç å‡ ä¹éƒ½æ˜¯åœ¨å“åº”æŸä¸ªäº‹ä»¶ï¼Œä¾‹å¦‚æŒ‰é’®çš„ç‚¹å‡»ï¼Œæ”¶åˆ°ç½‘ç»œæ¶ˆæ¯ï¼Œå±æ€§çš„å˜åŒ–ï¼ˆé€šè¿‡KVOï¼‰æˆ–è€…ç”¨æˆ·ä½ç½®çš„å˜åŒ–ï¼ˆé€šè¿‡CoreLocationï¼‰ã€‚ä½†æ˜¯è¿™äº›äº‹ä»¶éƒ½ç”¨ä¸åŒçš„æ–¹å¼æ¥å¤„ç†ï¼Œæ¯”å¦‚actionã€delegateã€KVOã€callbackç­‰ã€‚ReactiveCocoaä¸ºäº‹ä»¶å®šä¹‰äº†ä¸€ä¸ªæ ‡å‡†æ¥å£ï¼Œä»è€Œå¯ä»¥ä½¿ç”¨ä¸€äº›åŸºæœ¬å·¥å…·æ¥æ›´å®¹æ˜“çš„è¿æ¥ã€è¿‡æ»¤å’Œç»„åˆã€‚

  RACæ˜¯ç”± `Mattt Thompson` å¤§ç¥å¼€å‘çš„ï¼Œå¾ˆå¤šå¼€å‘è€…å¯¹å…¶çš„è¯„ä»·æ˜¯`å¼€å¯ä¸€ä¸ªæ–°Objective-Cçºªå…ƒ`ï¼Œå¯è§å¯¹å…¶è¯„ä»·æœ‰å¤šé«˜ã€‚
 ä»¥ä¸‹æ˜¯RACçš„Githubä¸»é¡µï¼š[ReactiveCocoa](https://github.com/ReactiveCocoa/ReactiveCocoa)
 ä»¥åŠå®˜æ–¹ç»™å‡ºçš„[ç”¨æ³•é“¾æ¥](https://github.com/ReactiveCocoa/ReactiveCocoa/tree/master/Documentation/Legacy)
 
## å®‰è£…

  ReactiveCocoaå®‰è£…æ•™ç¨‹æˆ‘å°±ä¸è¯´äº†ï¼Œç”¨podå®‰è£…å³å¯ã€‚
  æœ¬æ–‡çš„Demoå¯åœ¨æ–‡ç« æœ€åä¸‹è½½,åœ¨é˜…è¯»æœ¬æ–‡çš„æ—¶å€™ï¼Œå¼ºçƒˆæ¨èè¾¹çœ‹Demoè¾¹çœ‹åšæ–‡ã€‚
  é¡¹ç›®ä¸­åŠ å…¥äº†ReactiveCocoa å’Œ DeveloperLx å¤§ç¥çš„æ‰“å°æ’ä»¶ [LxDBAnything](https://github.com/DeveloperLx/LxDBAnything)ã€‚
  åŒæ—¶åŠ å…¥äº†é”®ç›˜ç›¸åº”çš„ç¬¬ä¸‰æ–¹[IQKeyboardManager](https://github.com/hackiftekhar/IQKeyboardManager)ï¼Œç„¶è€Œæ²¡æœ‰æ€ä¹ˆç”¨åˆ°ã€‚
  ä»¥åŠ[Masonry](https://github.com/SnapKit/Masonry),ä½¿ç”¨æ–¹æ³•å¯ä»¥çœ‹è¿™ç¯‡æ–‡ç« ï¼Œ[iOS - Masonryè‡ªåŠ¨å¸ƒå±€(Autolayout)](http://yimouleng.com/2014/12/02/ios-Masonry/)ã€‚
  
## æ’¸ä»£ç 

### ç¬¬ä¸€éƒ¨åˆ† ç®€å•ä½¿ç”¨

#### æ–‡æœ¬æ¡†äº‹ä»¶

åŸæ¥æˆ‘ä»¬åœ¨ä½¿ç”¨`textFiled`çš„æ—¶å€™æˆ‘ä»¬éœ€è¦å†™åˆ°

```
 [textField addTarget:self action:@selector(textChanged:) forControlEvents:UIControlEventEditingChanged];
 
 ```
 ç„¶åå®ç°`textChanged:`æ–¹æ³•ï¼Œåœ¨RACä¸­ï¼Œå¯¹äºæ–‡æœ¬æ¡†çš„ç›‘å¬ï¼Œæ˜¯éå¸¸ç®€å•çš„ä¸€ä»¶äº‹æƒ…ï¼Œçœ‹å¦‚ä¸‹ä»£ç ï¼š
 
```
 UITextField * textField = ({
        UITextField * textField = [[UITextField alloc]init];
        textField.backgroundColor = [UIColor cyanColor];
        
        textField;
    });
   [self.view addSubview:textField];
    
    @weakify(self); //  __weak __typeof__(self) self_weak_ = self;
    
    [textField mas_makeConstraints:^(MASConstraintMaker *make) {
        
        @strongify(self);    // __strong __typeof__(self) self = self_weak_;
        make.size.mas_equalTo(CGSizeMake(180, 40));
        make.center.equalTo(self.view);
    }];
    
    [[textField rac_signalForControlEvents:UIControlEventEditingChanged]
     subscribeNext:^(id x) {
         
         LxDBAnyVar(x);
     }];
    [textField.rac_textSignal subscribeNext:^(NSString *x) {
        
        LxDBAnyVar(x);
    }];


```

æ‰“å°ç»“æœï¼š

```
ğŸ“__31-[ViewController textFiledTest]_block_invoke_2 + 215ğŸˆ x = 12
ğŸ“__31-[ViewController textFiledTest]_block_invoke241 + 211ğŸˆ x = <UITextField: 0x7fe810c51a90; frame = (97.5 313.5; 180 40); text = '123'; clipsToBounds = YES; opaque = NO; gestureRecognizers = <NSArray: 0x7fe810f58fb0>; layer = <CALayer: 0x7fe810c51600>>
ğŸ“__31-[ViewController textFiledTest]_block_invoke_2 + 215ğŸˆ x = 123
ğŸ“__31-[ViewController textFiledTest]_block_invoke241 + 211ğŸˆ x = <UITextField: 0x7fe810c51a90; frame = (97.5 313.5; 180 40); text = '1231'; clipsToBounds = YES; opaque = NO; gestureRecognizers = <NSArray: 0x7fe810f58fb0>; layer = <CALayer: 0x7fe810c51600>>
ğŸ“__31-[ViewController textFiledTest]_block_invoke_2 + 215ğŸˆ x = 1231
ğŸ“__31-[ViewController textFiledTest]_block_invoke241 + 211ğŸˆ x = <UITextField: 0x7fe810c51a90; frame = (97.5 313.5; 180 40); text = '12312'; clipsToBounds = YES; opaque = NO; gestureRecognizers = <NSArray: 0x7fe810f58fb0>; layer = <CALayer: 0x7fe810c51600>>
ğŸ“__31-[ViewController textFiledTest]_block_invoke_2 + 215ğŸˆ x = 12312
ğŸ“__31-[ViewController textFiledTest]_block_invoke241 + 211ğŸˆ x = <UITextField: 0x7fe810c51a90; frame = (97.5 313.5; 180 40); text = '123123'; clipsToBounds = YES; opaque = NO; gestureRecognizers = <NSArray: 0x7fe810f58fb0>; layer = <CALayer: 0x7fe810c51600>>
ğŸ“__31-[ViewController textFiledTest]_block_invoke_2 + 215ğŸˆ x = 123123

```

æˆ‘ä»¬å¾ˆå®¹æ˜“çš„ç›‘å¬åˆ°`textFiled`ä¸­å‘ç”Ÿçš„å˜åŒ–ï¼Œå…¶ä¸­xçš„ç±»å‹é»˜è®¤ä¸ºidç±»å‹ï¼Œ æˆ‘ä»¬å·²çŸ¥å®ƒçš„ç±»å‹çš„æ—¶å€™æˆ‘ä»¬å¯ä»¥å°†å…¶æ”¹å˜ï¼Œå°±åƒä¸Šé¢ä»£ç ï¼Œå°†idæ”¹æˆäº†NSStringç±»å‹ã€‚
#### æ‰‹åŠ¿

```
self.view.userInteractionEnabled = YES;
    UITapGestureRecognizer * tap = [[UITapGestureRecognizer alloc]init];
    [[tap rac_gestureSignal] subscribeNext:^(UITapGestureRecognizer * tap) {
        
        LxDBAnyVar(tap);
    }];
    [self.view addGestureRecognizer:tap];

```
ä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘ä»¬ç›´æ¥æ·»åŠ åˆ°self.viewä¸Šï¼Œç‚¹å‡»å±å¹•ï¼Œå¾—åˆ°æ‰“å°ç»“æœï¼š

```
ğŸ“__29-[ViewController gestureTest]_block_invoke + 184ğŸˆ tap = <UITapGestureRecognizer: 0x7fa2e3e1f9f0; state = Ended; view = <UIView 0x7fa2e3e20b70>; target= <(action=sendNext:, target=<RACPassthroughSubscriber 0x7fa2e3c064f0>)>>
```
#### é€šçŸ¥

```
 [[[NSNotificationCenter defaultCenter] rac_addObserverForName:UIApplicationDidEnterBackgroundNotification object:nil] subscribeNext:^(NSNotification * notification) {
        
        LxDBAnyVar(notification);
    }];
    
```
æˆ‘ä»¬å»ºç«‹äº†ä¸€ä¸ªé€šçŸ¥ï¼Œå«åšè¿›å…¥åå°ï¼Œ å½“ç¨‹åºè¿›å…¥åå°çš„æ—¶å€™é€šçŸ¥ç›¸åº”ï¼Œå½“æˆ‘ä»¬ç”¨RACå†™é€šçŸ¥çš„æ—¶å€™ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªå¥½å¤„ï¼Œå°±æ˜¯ä¸ç”¨removeObserveré€šçŸ¥ï¼Œå› ä¸ºRACé€šçŸ¥çš„ç›‘å¬è€…å¸ˆRACè‡ªå·±ï¼Œå®ƒä¼šå¸®ä½ ç®¡ç†é‡Šæ”¾æ–¹æ³•ã€‚å¯ä»¥çœ‹æ–¹æ³•å®ç°å¦‚ä¸‹ï¼š

```
- (RACSignal *)rac_addObserverForName:(NSString *)notificationName object:(id)object {
	@unsafeify(object);
	return [[RACSignal createSignal:^(id<RACSubscriber> subscriber) {
		@strongify(object);
		id observer = [self addObserverForName:notificationName object:object queue:nil usingBlock:^(NSNotification *note) {
			[subscriber sendNext:note];
		}];

		return [RACDisposable disposableWithBlock:^{
			[self removeObserver:observer];
		}];
	}] setNameWithFormat:@"-rac_addObserverForName: %@ object: <%@: %p>", notificationName, [object class], object];
}
```

#### å®šæ—¶å™¨

```
    //1. å»¶è¿ŸæŸä¸ªæ—¶é—´åå†åšæŸä»¶äº‹
    [[RACScheduler mainThreadScheduler]afterDelay:2 schedule:^{
        
        LxPrintAnything(rac);
    }];
    
    //2. æ¯é—´éš”å¤šé•¿æ—¶é—´åšä¸€ä»¶äº‹
    [[RACSignal interval:1 onScheduler:[RACScheduler mainThreadScheduler]]subscribeNext:^(NSDate * date) {
        
        LxDBAnyVar(date);
    }];

```

è¿™æ˜¯å®šæ—¶å™¨æœ€å¸¸ç”¨çš„ä¸¤ç§å†™æ³•ï¼Œç¬¬ä¸€ç§æ–¹æ³•ï¼Œå»¶è¿Ÿæ—¶é—´å»åšæŸä»¶äº‹ï¼Œæ›´æ”¹`afterDelay`çš„å±æ€§ã€‚
ç¬¬äºŒç§æ–¹æ³•ï¼Œæ¯é—´éš”å¤šé•¿æ—¶é—´åšä¸€ä»¶äº‹ï¼Œæ›´æ”¹`interval`å±æ€§ã€‚


#### ä»£ç†

```
 UIAlertView * alertView = [[UIAlertView alloc]initWithTitle:@"RAC" message:@"ReactiveCocoa" delegate:self cancelButtonTitle:@"Cancel" otherButtonTitles:@"Ensure", nil];
    
    [[self rac_signalForSelector:@selector(alertView:clickedButtonAtIndex:) fromProtocol:@protocol(UIAlertViewDelegate)] subscribeNext:^(RACTuple * tuple) {
        
        LxDBAnyVar(tuple);
        
        LxDBAnyVar(tuple.first);
        LxDBAnyVar(tuple.second);
        LxDBAnyVar(tuple.third);
    }];
    [alertView show];
    
    
    //	æ›´ç®€å•çš„æ–¹å¼ï¼š
    [[alertView rac_buttonClickedSignal]subscribeNext:^(id x) {
        
        LxDBAnyVar(x);
    }];


```

ç”¨RACå»å†™ä»£ç†çš„æ—¶å€™ï¼Œä¼šæœ‰å±€é™ï¼Œåªèƒ½å–ä»£æ²¡æœ‰è¿”å›å€¼çš„ä»£ç†æ–¹æ³•ï¼Œä»€ä¹ˆæ˜¯æ²¡æœ‰è¿”å›å€¼çš„ä»£ç†å‘¢ï¼Ÿæ¯”å¦‚è¯´tableViewçš„ä»£ç†æ–¹æ³•ï¼š

```
- (CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath


- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath

```

è¿™ä¸¤ä¸ªæ–¹æ³•ä¸€ä¸ªè¿”å›çš„æ˜¯`CGFloat`ï¼Œä¸€ä¸ªæ˜¯`void`ï¼ŒRACåªèƒ½å–ä»£voidçš„ä»£ç†ã€‚

#### KVO

```
    UIScrollView * scrollView = [[UIScrollView alloc]init];
    scrollView.delegate = (id<UIScrollViewDelegate>)self;
    [self.view addSubview:scrollView];
    
    UIView * scrollViewContentView = [[UIView alloc]init];
    scrollViewContentView.backgroundColor = [UIColor yellowColor];
    [scrollView addSubview:scrollViewContentView];
    
    @weakify(self);
    
    [scrollView mas_makeConstraints:^(MASConstraintMaker *make) {
        
        @strongify(self);
        make.edges.equalTo(self.view).insets(UIEdgeInsetsMake(80, 80, 80, 80));
    }];
    
    [scrollViewContentView mas_makeConstraints:^(MASConstraintMaker *make) {
        
        @strongify(self);
        make.edges.equalTo(scrollView);
        make.size.mas_equalTo(CGSizeMake(CGRectGetWidth(self.view.frame), CGRectGetHeight(self.view.frame)));
    }];
    
    [RACObserve(scrollView, contentOffset) subscribeNext:^(id x) {
       
        LxDBAnyVar(x);
    }];


```

ç”¨RACå†™KVOçš„å¥½å¤„å°±æ˜¯æ–¹æ³•ç®€å•ï¼Œkeypathæœ‰ä»£ç æç¤ºã€‚

### ç¬¬äºŒéƒ¨åˆ† è¿›é˜¶

#### ä¿¡å·
```
  - (RACSignal *)loginSignal
    {
        return [RACSignal createSignal:^RACDisposable *(id<RACSubscriber> subscriber) {
            
            RACDisposable * schedulerDisposable = [[RACScheduler mainThreadScheduler]afterDelay:2 schedule:^{
               
                if (arc4random()%10 > 1) {
                    
                    [subscriber sendNext:@"Login response"];
                    [subscriber sendCompleted];
                }
                else {
                    
                    [subscriber sendError:[NSError errorWithDomain:@"LOGIN_ERROR_DOMAIN" code:444 userInfo:@{}]];
                }
            }];
            
            return [RACDisposable disposableWithBlock:^{
                
                [schedulerDisposable dispose];
            }];
        }];
    }

```

RACçš„æ ¸å¿ƒå°±æ˜¯RACSignalï¼Œä¹Ÿå°±æ˜¯ä¿¡å·ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åˆ›å»ºä¿¡å·`createSignal`ï¼Œå¹¶å‘é€å®ƒ`sendNext`ï¼Œå½“ä¿¡å·å®Œæˆåæˆ‘ä»¬åŒæ—¶ç”¨`dispose`æ–¹æ³•é”€æ¯å®ƒã€‚å‘é€ä¿¡å·ï¼Œæˆ‘ä»¬åŒæ—¶ä¹Ÿè¦è®¢é˜…ä¿¡å·ï¼Œè®¢é˜…ä¿¡å·ä»£ç å¦‚ä¸‹ï¼š
```
    [signal subscribeNext:^(id x) {
         
         LxDBAnyVar(x);
     } error:^(NSError *error) {
         
         LxDBAnyVar(error);
     } completed:^{
         
         LxPrintAnything(completed);
     }];


```

åœ¨ä¿¡å·å‘é€çš„æ—¶å€™ï¼Œ é”™è¯¯çš„æ—¶å€™ï¼Œä»¥åŠå®Œæˆçš„æ—¶å€™ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥å¾—åˆ°ç›¸åº”ã€‚

#### ä¿¡å·çš„å¤„ç†
##### map ï¼ˆæ˜ å°„ï¼‰
```
UITextField * textField = ({
        UITextField * textField = [[UITextField alloc]init];
        textField.backgroundColor = [UIColor cyanColor];
        
        textField;
    });
    [self.view addSubview:textField];
    
    @weakify(self); //  __weak __typeof__(self) self_weak_ = self;
    
    [textField mas_makeConstraints:^(MASConstraintMaker *make) {
        
        @strongify(self);    // __strong __typeof__(self) self = self_weak_;
        make.size.mas_equalTo(CGSizeMake(180, 40));
        make.center.equalTo(self.view);
    }];

    [[textField.rac_textSignal map:^id(NSString *text) {
        
       LxDBAnyVar(text);
        
        return @(text.length);
        
    }] subscribeNext:^(id x) {
         LxDBAnyVar(x);
    }];
```
mapè¿™ä¸ªå‡½æ•°ï¼Œåœ¨è¿™é‡Œä¸æ˜¯åœ°å›¾çš„æ„æ€ï¼Œä»£è¡¨æ˜ å°„ã€‚mapèƒ½åšçš„äº‹æƒ…å°±æ˜¯æŠŠç›‘å¬çš„`rac_textSignal`æ‰€è¿”å›çš„å€¼ï¼Œæ›¿æ¢æˆåˆ«çš„å°±åƒä¸Šé¢ä»£ç ä¸­çš„textçš„é•¿åº¦ã€‚

##### filter
ä¸ºäº†æ–¹ä¾¿æ¼”ç¤ºï¼Œæˆ‘å°±ä¸å†èµ‹å€¼åˆ›å»º`textField`çš„ä»£ç äº†ï¼Œè¯·åˆ°Demoä¸­æŸ¥çœ‹
```
[[[textField.rac_textSignal map:^id(NSString *text) {
        
       LxDBAnyVar(text);
        
        return @(text.length);
        
    }]filter:^BOOL(NSNumber *value) {
        
        return value.integerValue > 3;
        
    }] subscribeNext:^(id x) {
         LxDBAnyVar(x);
    }];
```

filteræ˜¯ä¸ªBOOLå€¼ï¼Œå®ƒä»£è¡¨çš„æ˜¯ä¸€ä¸ªæ¡ä»¶ï¼Œå½“è¿™ä¸ªæ¡ä»¶å‘ç”Ÿçš„æ—¶å€™æ‰ä¼šä½œå‡ºç›¸åº”ï¼Œæ¯”å¦‚ä¸Šé¢ä»£ç ä¸­ï¼Œå½“é•¿åº¦å¤§äº3çš„æ—¶å€™ï¼Œæ‰ä¼šæ‰“å°xçš„å€¼ã€‚

##### delay

```
//åˆ›å»ºä¿¡å·
    RACSignal * signal = [[RACSignal createSignal:^RACDisposable *(id<RACSubscriber> subscriber) {
        [subscriber sendNext:@"rac"];
        [subscriber sendCompleted];
        return nil;
    }]delay:2];
    LxPrintAnything(start);
    //åˆ›å»ºè®¢é˜…è€…
    [signal subscribeNext:^(id x) {
        LxDBAnyVar(x);
    }];

```

`delay`çš„ä½œç”¨å°±æ˜¯å»¶è¿Ÿï¼Œæˆ–è€…è¯´ç­‰å¾…ï¼Œå¦‚ä¸Šï¼Œç­‰å¾…2ç§’ä¹‹åæ‰“å°äº†xã€‚

##### startWith 

```
RACSignal * signal = [[RACSignal createSignal:^RACDisposable *(id<RACSubscriber> subscriber) {
        
//        [subscriber sendNext:@"123"];//startWith:@"123"ç­‰åŒäºè¿™å¥è¯ ä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ªå‘é€ï¼Œä¸»è¦æ˜¯ä½ç½®
        [subscriber sendNext:@"rac"];
        [subscriber sendCompleted];
        return nil;
    }]startWith:@"123"];
    LxPrintAnything(start);
    //åˆ›å»ºè®¢é˜…è€…
    [signal subscribeNext:^(id x) {
        LxDBAnyVar(x);
    }];

```
`startWith`ä¹Ÿå°±æ˜¯æœ€å¼€å§‹çš„æ„æ€ï¼Œçœ‹ä»¥ä¸Šä»£ç  `startWith:@"123"`ç­‰åŒäº`[subscriber sendNext:@"123"]` ä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ªå‘é€ï¼Œä¸»è¦æ˜¯ä½ç½®.

##### timeOut

```
[[[RACSignal createSignal:^RACDisposable *(id<RACSubscriber> subscriber) {
        
        [[RACScheduler mainThreadScheduler]afterDelay:3 schedule:^{
            
            [subscriber sendNext:@"rac"];
            [subscriber sendCompleted];
        }];
        
        return nil;
    }] timeout:2 onScheduler:[RACScheduler mainThreadScheduler]]
     subscribeNext:^(id x) {
         
         LxDBAnyVar(x);
     } error:^(NSError *error) {
         
         LxDBAnyVar(error);
     } completed:^{
         
         LxPrintAnything(completed);
     }];

```

ä¸Šé¢ä»£ç çš„æ„æ€å°±æ˜¯ï¼Œæˆ‘ç­‰å¾…3ç§’ä¸­å‘é€(`afterDelay`),ä½†æ˜¯æˆ‘è¶…æ—¶äº†(`timeout`)2ç§’é’Ÿæ‰å‘é€ï¼Œæ‰€ä»¥è¿™æ¡ä¿¡æ¯å‘ç”Ÿé”™è¯¯ï¼Œä¼šèµ°`error`çš„æ–¹æ³•ã€‚  è¿™ç§æƒ…å†µå¯ä»¥ç”¨åœ¨å°è£…`http client`ä¸­ï¼Œå½“ç„¶ä½ å¯èƒ½é‡åˆ°åˆ«çš„éœ€æ±‚ï¼Œä¹Ÿéœ€è¦å®ƒã€‚


##### take -- skip

```
 RACSignal * signal = [[RACSignal createSignal:^RACDisposable *(id<RACSubscriber> subscriber) {
        [subscriber sendNext:@"rac1"];
        [subscriber sendNext:@"rac2"];
        [subscriber sendNext:@"rac3"];
        [subscriber sendNext:@"rac4"];
        [subscriber sendCompleted];
        return nil;
    }]take:2];//Skip

    [signal subscribeNext:^(id x) {
        LxDBAnyVar(x);
    }];

```

æ¯”å¦‚è¯´æˆ‘ä»¬å‘é€äº†å¾ˆå¤šæ¬¡è¯·æ±‚
>takeè¡¨ç¤ºæˆ‘ä»¬åªå–å‰ä¸¤æ¬¡
>skipè¡¨ç¤ºè·³è¿‡å‰ä¸¤æ¬¡
>takeLastè¡¨ç¤ºå€’æ•°çš„å‰ä¸¤æ¬¡
>takeUntilè¿™ä¸ªå€¼æ¯”è¾ƒç‰¹æ®Šï¼Œä»–åé¢çš„å‚æ•°æ˜¯ä¸ªä¿¡å·ï¼Œå®ƒçš„æ„æ€æ˜¯ï¼Œå½“takeUntilå‘é€è¿™ä¸ªä¿¡å·çš„æ—¶å€™ï¼Œä¸Šé¢çš„å‘é€ä¿¡å·å°±ä¼šåœæ­¢å‘é€ã€‚

æ¥ä¸‹æ¥æ˜¯å‡ ä¸ªblockå›è°ƒæ–¹æ³•
>takeWhileBlock BOOLå€¼ï¼Œæ„æ€æ˜¯å½“è¿”å›YESçš„æ—¶å€™ï¼Œè®¢é˜…è€…æ‰èƒ½æ”¶åˆ°ä¿¡å·
>skipWhileBlock BOOLå€¼ï¼Œæ„æ€æ˜¯å½“è¿”å›YESçš„æ—¶å€™ï¼Œè®¢é˜…è€…å°±ä¼šè·³è¿‡ä¿¡å·ï¼ŒNOçš„æ—¶å€™æ‰æ¥å—
>skipUntilBlock BOOLå€¼ï¼Œæ„æ€æ˜¯ è¿”å›NOçš„æ—¶å€™ï¼Œä¸ä¼šæ”¶åˆ°æ¶ˆæ¯ï¼Œ ç›´åˆ°è¿”å›YESçš„æ—¶å€™æ‰å¼€å§‹æ”¶æ¶ˆæ¯ã€‚

##### å³æ—¶æœç´¢ä¼˜åŒ– (throttle,distinctUntilChanged,ignore)

```
 UITextField * textField = [[UITextField alloc]init];
    textField.backgroundColor = [UIColor cyanColor];
    [self.view addSubview:textField];
    
    @weakify(self);
    
    [textField mas_makeConstraints:^(MASConstraintMaker *make) {
        
        @strongify(self);
        make.size.mas_equalTo(CGSizeMake(180, 40));
        make.center.equalTo(self.view);
    }];
    //throttle åé¢æ˜¯ä¸ªæ—¶é—´ è¡¨ç¤ºrac_textSignalå‘é€æ¶ˆæ¯ï¼Œ0.3ç§’å†…æ²¡æœ‰å†æ¬¡å‘é€å°±ä¼šç›¸åº”ï¼Œè‹¥æ˜¯0.3å†…åˆå‘é€æ¶ˆæ¯äº†ï¼Œä¾¿ä¼šåœ¨æ–°çš„ä¿¡æ¯å¤„é‡æ–°è®¡æ—¶
    //distinctUntilChanged è¡¨ç¤ºä¸¤ä¸ªæ¶ˆæ¯ç›¸åŒçš„æ—¶å€™ï¼Œåªä¼šå‘é€ä¸€ä¸ªè¯·æ±‚
    //ignore è¡¨ç¤ºå¦‚æœæ¶ˆæ¯å’Œignoreåé¢çš„æ¶ˆæ¯ç›¸åŒï¼Œåˆ™ä¼šå¿½ç•¥æ‰è¿™æ¡æ¶ˆæ¯ï¼Œä¸è®©å…¶å‘é€
    [[[[[[textField.rac_textSignal throttle:0.3] distinctUntilChanged] ignore:@""] map:^id(id value) {
        
        return [RACSignal createSignal:^RACDisposable *(id<RACSubscriber> subscriber) {
            
            //  network request
            [subscriber sendNext:value];
            [subscriber sendCompleted];
            
            return [RACDisposable disposableWithBlock:^{
                
                //  cancel request
            }];
        }];
    }]switchToLatest] subscribeNext:^(id x) {
        
        LxDBAnyVar(x);
    }];

```
ä»¥ä¸Šä»£ç ï¼Œæ˜¯ç”¨textFieldæ¨¡æ‹Ÿä¸€ä¸ªå³æ—¶æœç´¢ä¼˜åŒ–çš„åŠŸèƒ½ï¼Œå…¶ä¸­å‚æ•°å¦‚ä¸‹ï¼š
>throttle åé¢æ˜¯ä¸ªæ—¶é—´ è¡¨ç¤ºrac_textSignalå‘é€æ¶ˆæ¯ï¼Œ0.3ç§’å†…æ²¡æœ‰å†æ¬¡å‘é€å°±ä¼šç›¸åº”ï¼Œè‹¥æ˜¯0.3å†…åˆå‘é€æ¶ˆæ¯äº†ï¼Œä¾¿ä¼šåœ¨æ–°çš„ä¿¡æ¯å¤„é‡æ–°è®¡æ—¶
>distinctUntilChanged è¡¨ç¤ºä¸¤ä¸ªæ¶ˆæ¯ç›¸åŒçš„æ—¶å€™ï¼Œåªä¼šå‘é€ä¸€ä¸ªè¯·æ±‚
>ignore è¡¨ç¤ºå¦‚æœæ¶ˆæ¯å’Œignoreåé¢çš„æ¶ˆæ¯ç›¸åŒï¼Œåˆ™ä¼šå¿½ç•¥æ‰è¿™æ¡æ¶ˆæ¯ï¼Œä¸è®©å…¶å‘é€

è¿™æ ·åšï¼Œæ˜¯ä¸æ˜¯ç»™æœåŠ¡å™¨å‡å°äº†å¾ˆå¤šçš„å‹åŠ›ï¼Œæ›´æ˜¯èŠ‚çœäº†æˆ‘ä»¬å¤§é‡çš„ä»£ç ã€‚ å…¶ä¸­æˆ‘ä»¬ç”¨mapå»ºç«‹äº†ä¸€ä¸ªæ–°çš„ä¿¡å·ï¼Œæˆ‘ä»¬çŸ¥é“textFieldçš„æ”¹å˜æ˜¯ä¸€ä¸ªä¿¡å·ï¼Œ mapå°±æ˜¯åœ¨è¿™ä¸ªä¿¡å·ä¸Šï¼ŒåˆåŠ äº†ä¸€ä¸ªä¿¡å·ï¼Œå³`signal of signals`ã€‚
è®¢é˜…è€…æ‰€æ‰“å°çš„æ¶ˆæ¯xåˆ™æ˜¯ï¼Œmapå‘å‡ºçš„ä¿¡å·ã€‚æˆ‘ä»¬å¯ä»¥å†mapä¸­å‘é€æ–°çš„ä¿¡å·ï¼Œä»¥åŠå–æ¶ˆä¿¡å·`disposable`.
å½“æˆ‘ä»¬ç”¨mapå‘é€ä¿¡å·çš„æ—¶å€™ï¼Œæˆ‘ä»¬åˆ™éœ€è¦ä½¿ç”¨ `switchToLatest`è¿™ä¸ªå‚æ•°æ¥è·å–æœ€åä¸€ä¸ªä¿¡å·ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æœ€åæ‰€æ‰“å°çš„xï¼Œå°±æ˜¯mapæœ€åå‘é”™çš„è¿™ä¸ªä¿¡å·ã€‚

##### repeat
```
 [[[[[RACSignal createSignal:^RACDisposable *(id<RACSubscriber> subscriber) {
        
        [subscriber sendNext:@"rac"];
        [subscriber sendCompleted];
        
        return nil;
    }]delay:1]repeat]take:3] subscribeNext:^(id x) {
	       
        LxDBAnyVar(x);
    } completed:^{
        
        LxPrintAnything(completed);
    }];
```
repeat,é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯é‡å¤å‘é€è¿™æ¡æ¶ˆæ¯ï¼Œå½“æˆ‘ä»¬åœ¨åé¢æ·»åŠ äº†delayå’Œtakeçš„æ—¶å€™ï¼Œæ„æ€å°±æ˜¯æ¯éš”1ç§’å‘é€ä¸€æ¬¡è¿™æ¡æ¶ˆæ¯ï¼Œå‘é€3æ¬¡ååœæ­¢ã€‚

##### merge --  concat -- zipWith

```
 RACSignal * signalA = [RACSignal createSignal:^RACDisposable *(id<RACSubscriber> subscriber) {
        
        dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(2 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
            LxPrintAnything(a);
            [subscriber sendNext:@"a"];
            [subscriber sendCompleted];
        });
        
        return nil;
    }];
    
    RACSignal * signalB = [RACSignal createSignal:^RACDisposable *(id<RACSubscriber> subscriber) {
        
        dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(3 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
            LxPrintAnything(b);
            [subscriber sendNext:@"b"];
            [subscriber sendCompleted];
        });
        
        return nil;
    }];
    
    [[RACSignal merge:@[signalA, signalB]]subscribeNext:^(id x) {
        
        LxDBAnyVar(x);
    }];

```
æˆ‘ä»¬åˆ›å»ºäº†ä¸¤ä¸ªè¯·æ±‚ï¼ŒAå’ŒBï¼Œç”¨GCDçš„æ–¹æ³•Aå»¶è¿Ÿä¸¤ç§’é’Ÿï¼ŒBå»¶è¿Ÿäº†3ç§’é’Ÿï¼Œæˆ‘ä»¬ç”¨`merge`æ–¹æ³•åˆå¹¶äº†Aå’ŒBï¼Œæ‰“å°ç»“æœä¸º
```
ğŸ“__23-[ViewController merge]_block_invoke_2 + 66ğŸˆ a
ğŸ“__23-[ViewController merge]_block_invoke29 + 87ğŸˆ x = a
ğŸ“__23-[ViewController merge]_block_invoke_215 + 77ğŸˆ b
ğŸ“__23-[ViewController merge]_block_invoke29 + 87ğŸˆ x = b

```

ä¹Ÿå°±æ˜¯Aå’ŒBä¸ç®¡è°å‘é€éƒ½ä¼šæ‰“å°xï¼Œç®€å•çš„è¯´å°±æ˜¯Aå’ŒBçš„æ‰“å°æ–¹æ³•ç”¨çš„æ˜¯åŒä¸€ä¸ªã€‚ä»–ä»¬ä¹‹é—´å…³ç³»æ˜¯ç‹¬ç«‹çš„ï¼Œå¦‚æœAå‘é€å¤±è´¥ï¼ŒBä¾ç„¶ä¼šæ‰§è¡Œã€‚

å½“æˆ‘ä»¬ç”¨`concat`æ–¹æ³•é“¾æ¥Aå’ŒBä¹‹åï¼Œæ„æ€å°±æ˜¯å½“Aæ‰§è¡Œå®Œäº†ä¹‹åæ‰ä¼šæ‰§è¡ŒBï¼Œä»–ä»¬ä¹‹é—´æ˜¯ä¾èµ–çš„å…³ç³»ï¼Œå¦‚æœAå‘é€å¤±è´¥ï¼ŒBä¹Ÿä¸ä¼šæ‰§è¡Œã€‚

è¯·æ³¨æ„åˆå¹¶(merge)å’Œé“¾æ¥(concat)çš„åŒºåˆ«ã€‚

`zipWith`ï¼Œå½“ç”¨`zipWith`é“¾æ¥Aå’ŒBçš„æ—¶å€™ï¼Œåªæœ‰åœ¨A.Bæ¯éš”éƒ½è‡³å°‘å‘é€è¿‡ä¸€æ¬¡æ¶ˆæ¯çš„æ—¶å€™æ‰ä¼šæ‰§è¡ŒzipWithçš„æ–¹æ³•ï¼Œå®ƒçš„è¿”å›å€¼æ˜¯ä¸€ä¸ªé›†åˆï¼Œä¹Ÿå°±æ˜¯æ•°ç»„ï¼ŒåŒæ—¶åŒ…å«äº†Aå’ŒBçš„æ‰“å°ç»“æœã€‚
`zipWith`çš„å†™æ³•ç­‰åŒäº ï¼š

```
[[RACSignal combineLatestWith:@[signalA, signalB]subscribeNext:^(id x) {
        
        LxDBAnyVar(x);
    }];
```

äº¦æˆ–è€…

```
[[RACSignal combineLatest:@[signalA, signalB]]subscribeNext:^(id x) {
        
        LxDBAnyVar(x);
    }];

```

ä½†æ˜¯ä½¿ç”¨`combineLatest`ï¼Œå¯ä»¥å†åé¢æ·»åŠ æ›´å¤šçš„ä¿¡å·.



### RAC(<#TARGET, ...#>) å®

```
//button setBackgroundColor:forState:
    
    UIButton * button = [UIButton buttonWithType:UIButtonTypeCustom];
    [self.view addSubview:button];
    
    @weakify(self);
    
    [button mas_makeConstraints:^(MASConstraintMaker *make) {
        
        @strongify(self);
        make.size.mas_equalTo(CGSizeMake(180, 40));
        make.center.equalTo(self.view);
    }];
    
    RAC(button, backgroundColor) = [RACObserve(button, selected) map:^UIColor *(NSNumber * selected) {
        
        return [selected boolValue] ? [UIColor redColor] : [UIColor greenColor];
    }];
    
    [[button rac_signalForControlEvents:UIControlEventTouchUpInside]subscribeNext:^(UIButton * btn) {
        
        btn.selected = !btn.selected;
    }];
```

æ¯”å¦‚Btnçš„è®¾ç½®èƒŒæ™¯é¢œè‰²çš„å±æ€§ï¼ŒOCä¸­å¹¶æ²¡æœ‰`button setBackgroundColor:forState:`è¿™ç§æ–¹æ³•ï¼Œæˆ‘ä»¬ä¸èƒ½ç›´æ¥è®¾ç½®å…¶é€‰ä¸­åçš„é¢œè‰²ã€‚åœ¨RACä¸­ï¼Œåˆ™å¯ä»¥å¾ˆç®€å•çš„æ”¹å˜BTNçš„èƒŒæ™¯é¢œè‰²ã€‚ä¸å¾—ä¸è¯´RACçš„ç®€å•å’Œå¼ºå¤§ã€‚

#### åšä¸€ä¸ªç§’è¡¨

```
 UILabel * label = ({
       
        UILabel * label = [[UILabel alloc]init];
        label.backgroundColor = [UIColor cyanColor];
        label;
    });
    [self.view addSubview:label];
    
    @weakify(self);
    
    [label mas_makeConstraints:^(MASConstraintMaker *make) {
        @strongify(self);
        
        make.size.mas_equalTo(CGSizeMake(240, 40));
        make.center.equalTo(self.view);
        
    }];
    
    RAC(label, text) = [[RACSignal interval:1 onScheduler:[RACScheduler mainThreadScheduler]] map:^NSString *(NSDate * date) {
        
        return date.description;
    }];


```

åªæœ‰è¿™ä¹ˆå¤šä»£ç ï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥å®Œç¾çš„åšä¸€ä¸ªç§’è¡¨ï¼Œæ˜¯å¦å¾ˆcoolï¼Ÿ

![](/image/RAC.gif)


## ç»“æŸ

å½“æˆ‘ä»¬å¤§é‡ä½¿ç”¨RACå†™ä»£ç çš„æ—¶å€™ï¼Œä¼šæŠŠä¸€ä¸ªä¸ªäº‹ä»¶å°è£…æˆä¸€ä¸ªä¸ªä¿¡å·ï¼Œé€šè¿‡è§¦å‘ä¿¡å·ï¼Œè®¢é˜…è¿™ä¸ªä¿¡å·æ¥è¿”å›å„ç§ä¿¡æ¯ã€‚RACä½¿æˆ‘ä»¬çš„ä»£ç è€¦åˆæ€§æ ¹åº•ï¼Œèšåˆæ€§æ›´é«˜ã€‚


è‹¥æœ‰ä¸æ‡‚å¾—åœ°æ–¹å¯ä»¥ç•™è¨€ï¼Œè‹¥æœ‰å†™é”™çš„åœ°æ–¹ï¼Œè¯·åŠæ—¶ä¸æˆ‘è”ç³»ï¼Œå¯ä»¥ç•™è¨€æˆ–è€…Emailç­‰ã€‚

æ–‡æœ¬æ‰€ç”¨çš„Demoï¼Œä¸‹è½½åœ°å€ [æˆ³è¿™é‡Œ](https://github.com/yimouleng/RACDemo).









 
  